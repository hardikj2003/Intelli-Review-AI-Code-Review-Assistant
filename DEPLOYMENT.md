# Multi-Tenant Deployment Guide for Intelli-Review

This guide explains how to deploy Intelli-Review on Render so multiple users can use the service with their own GitHub accounts.

## üèóÔ∏è Architecture Overview

The application now supports **multi-tenant architecture** where:
- Each user authenticates with their own GitHub account via OAuth
- Each user's GitHub token is stored securely in the database
- Webhooks are verified using per-repo secrets
- All services use per-user tokens instead of a shared token

## üìã Pre-Deployment Checklist

### 1. Database Migration

Before deploying, you need to run the Prisma migration to add the new fields:

```bash
cd dashboard
npx prisma migrate dev --name add_webhook_fields
```

This adds:
- `webhookSecret` field to Repository model
- `webhookId` field to Repository model
- Index on `fullName` for faster lookups

### 2. GitHub OAuth App Setup

1. Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí OAuth Apps
2. Click "New OAuth App"
3. Fill in:
   - **Application name**: Intelli-Review
   - **Homepage URL**: Your Render dashboard URL (e.g., `https://intelli-review-dashboard.onrender.com`)
   - **Authorization callback URL**: `https://intelli-review-dashboard.onrender.com/api/auth/callback/github`
4. Save and copy:
   - **Client ID** ‚Üí use as `GITHUB_ID`
   - **Client Secret** ‚Üí use as `GITHUB_SECRET`

### 3. Environment Variables to Set in Render

After creating services in Render, set these environment variables:

#### For `intelli-review-dashboard`:
- `GITHUB_ID` - Your GitHub OAuth App Client ID
- `GITHUB_SECRET` - Your GitHub OAuth App Client Secret
- `NEXTAUTH_URL` - Auto-set by Render (or set to your dashboard URL)
- `NEXTAUTH_SECRET` - Auto-generated by Render (or generate: `openssl rand -base64 32`)
- `DATABASE_URL` - Auto-set from database service
- `WEBHOOK_INGESTOR_URL` - Auto-set from webhook service

#### For `intelli-review-analysis-worker`:
- `OPENAI_API_KEY` - Your OpenAI API key (required for AI analysis)
- `RABBITMQ_URL` - Auto-set from RabbitMQ service
- `DATABASE_URL` - Not needed (workers don't access DB directly)

#### For `intelli-review-webhook`:
- `DATABASE_URL` - Auto-set from database service
- `RABBITMQ_URL` - Auto-set from RabbitMQ service
- `PORT` - Set to `3000` (or use auto-detected)

#### For `intelli-review-commenter`:
- `RABBITMQ_URL` - Auto-set from RabbitMQ service

**Note**: `GITHUB_TOKEN` is **NO LONGER NEEDED** as a global env var. Each user's token is stored in the database.

## üöÄ Deployment Steps

### Option 1: Using Render Blueprint (Recommended)

1. **Push your code to GitHub** (make sure `render.yaml` is in the root)

2. **Connect to Render**:
   - Go to https://dashboard.render.com
   - Click "New +" ‚Üí "Blueprint"
   - Connect your GitHub repository
   - Render will detect `render.yaml` and create all services

3. **Set Environment Variables**:
   - Go to each service's "Environment" tab
   - Set the required variables listed above
   - For secrets (`GITHUB_SECRET`, `OPENAI_API_KEY`), mark them as "Secret"

4. **Run Database Migration**:
   - Go to the dashboard service ‚Üí "Shell" tab
   - Run:
     ```bash
     cd dashboard
     npx prisma migrate deploy
     ```

5. **Deploy**:
   - All services will auto-deploy
   - Wait for all services to be "Live"

### Option 2: Manual Service Creation

If you prefer creating services manually:

1. **Create Database**:
   - New ‚Üí PostgreSQL
   - Name: `intelli-review-db`
   - Plan: Starter

2. **Create RabbitMQ**:
   - New ‚Üí RabbitMQ
   - Name: `intelli-review-rabbitmq`
   - Plan: Starter

3. **Create Webhook Ingestor**:
   - New ‚Üí Web Service
   - Environment: Docker
   - Build Command: (auto-detected)
   - Start Command: (auto-detected)
   - Root Directory: `webhook-ingestor`
   - Add environment variables

4. **Create Analysis Worker**:
   - New ‚Üí Background Worker
   - Environment: Docker
   - Root Directory: `analysis-worker`
   - Add environment variables

5. **Create Commenter Worker**:
   - New ‚Üí Background Worker
   - Environment: Docker
   - Root Directory: `github-commenter`
   - Add environment variables

6. **Create Dashboard**:
   - New ‚Üí Web Service
   - Environment: Node
   - Build Command: `cd dashboard && npm install && npx prisma generate && npx prisma migrate deploy && npm run build`
   - Start Command: `cd dashboard && npm start`
   - Root Directory: `dashboard`
   - Add environment variables

## üîí Security Features

### Multi-Tenant Security

1. **Webhook Verification**: Each webhook is verified using a per-repo secret stored in the database
2. **User Token Isolation**: Each user's GitHub token is isolated and used only for their repositories
3. **Repository Validation**: Webhook ingestor checks if a repo is enabled before processing
4. **OAuth Scopes**: Users grant minimal required permissions (`repo`, `read:user`, `admin:repo_hook`)

### Environment Variables Security

- All secrets are marked as "Secret" in Render (not visible in logs)
- Database connection strings are auto-injected and encrypted
- Webhook secrets are generated cryptographically secure

## üß™ Testing the Deployment

1. **Access Dashboard**:
   - Visit your dashboard URL
   - Sign in with GitHub

2. **Enable a Repository**:
   - Click "Enable" on one of your repositories
   - A webhook will be created automatically
   - Webhook secret is generated and stored

3. **Test Webhook**:
   - Create a new PR in the enabled repository
   - Check Render logs:
     - `intelli-review-webhook` should show webhook received
     - `intelli-review-analysis-worker` should process the PR
     - `intelli-review-commenter` should post a comment

## üìä Monitoring

### Service Health

- **Dashboard**: Check `/` endpoint
- **Webhook Ingestor**: Check `/` endpoint
- **Workers**: Check service logs in Render dashboard

### Logs Location

- Render Dashboard ‚Üí Select Service ‚Üí "Logs" tab
- Each service logs important events:
  - Webhook ingestor: Webhook receipts and verifications
  - Analysis worker: PR processing and AI analysis
  - Commenter: Comment posting

## üîÑ Updating the Application

1. **Make code changes**
2. **Commit and push to GitHub**
3. **Render auto-deploys** (if auto-deploy is enabled)
4. **Run migrations** if schema changed:
   ```bash
   cd dashboard
   npx prisma migrate dev
   npx prisma migrate deploy  # In Render shell
   ```

## üêõ Troubleshooting

### Webhook Not Receiving Events

1. Check webhook is enabled in GitHub:
   - Repo ‚Üí Settings ‚Üí Webhooks
   - Verify webhook URL is correct
   - Check recent deliveries

2. Check webhook ingestor logs:
   - Look for signature verification errors
   - Check database connection

### Workers Not Processing

1. Check RabbitMQ connection:
   - Verify `RABBITMQ_URL` is set correctly
   - Check RabbitMQ service is running

2. Check worker logs:
   - Look for connection errors
   - Verify user tokens are present in messages

### Database Connection Issues

1. Verify `DATABASE_URL` is set correctly
2. Check database service is running
3. Ensure migrations have run

## üí∞ Cost Estimation

For Render Starter plans (approximate monthly costs):
- PostgreSQL: $7/month
- RabbitMQ: $7/month
- Webhook Service: $7/month
- Analysis Worker: $7/month
- Commenter Worker: $7/month
- Dashboard: $7/month

**Total**: ~$42/month for all services on Starter plans

You can scale up individual services as needed.

## üìù Next Steps

- [ ] Set up custom domain for dashboard
- [ ] Configure auto-scaling for workers
- [ ] Set up monitoring/alerting
- [ ] Add rate limiting per user
- [ ] Implement usage analytics

## üÜò Support

If you encounter issues:
1. Check service logs in Render dashboard
2. Verify all environment variables are set
3. Ensure database migrations have run
4. Check GitHub OAuth app settings

